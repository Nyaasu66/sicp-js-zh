### 1.1.5 功能应用的替代模型

为了评估函数应用程序，解释器遵循 1.1.4 节中描述的过程。也就是说，解释器评估应用程序的元素，并将函数(应用程序的函数表达式的值)应用于自变量(应用程序的自变量表达式的值)。

我们可以假设原语函数的应用是由解释器或库来处理的。对于复合函数，应用过程如下:

*   若要将复合函数应用于参数，请用相应的参数替换每个参数，然后计算函数的返回表达式。 [^(11)](#c1-fn-0011)

为了说明这个过程，让我们来评估这个应用程序

```js
f(5)
```

其中`f`是 1.1.4 节中声明的函数。我们从检索`f`的返回表达式开始:

```js
sum_of_squares(a + 1, a * 2)
```

然后我们用自变量 5 替换参数`a`:

```js
sum_of_squares(5 + 1, 5 * 2)
```

因此，这个问题归结为用两个参数和一个函数表达式`sum_of_squares`评估一个应用程序。评估这个应用程序涉及三个子问题。我们必须对函数表达式求值以获得要应用的函数，并且必须对参数表达式求值以获得参数。现在`5 + 1`产生 6，`5 * 2`产生 10，所以我们必须对 6 和 10 应用`sum_of_squares`函数。这些值替换了`sum_of_squares`主体中的参数`x`和`y`，将表达式简化为

```js
square(6) + square(10)
```

如果我们使用`square`的声明，这就简化为

```js
(6 * 6) + (10 * 10)
```

这通过乘法减少到

```js
36 + 100
```

最后是

```js
136
```

我们刚刚描述的过程被称为函数应用的替代模型。就本章所涉及的功能而言，它可以被视为一个决定功能应用“意义”的模型。然而，有两点应该强调:

*   替换的目的是帮助我们思考函数的应用，而不是提供解释器如何真正工作的描述。典型的解释器不会通过操作函数文本来替换参数值，从而评估函数应用程序。实际上,“替换”是通过使用参数的本地环境来完成的。我们将在第三章和第四章中详细讨论解释器的实现。
*   在本书的整个过程中，我们将呈现一系列解释器如何工作的越来越精细的模型，最后在第五章中给出一个解释器和编译器的完整实现。替代模型只是这些模型中的第一个——一种开始正式思考评估过程的方法。一般来说，在对科学和工程中的现象建模时，我们从简化的、不完整的模型开始。当我们更详细地研究事物时，这些简单的模型变得不够用，必须被更精细的模型所取代。替代模型也不例外。特别是，当我们在第 3 章讨论“可变数据”函数的使用时，我们会看到替代模型失效，必须被一个更复杂的函数应用模型所取代。 [^(12)](#c1-fn-0012)

##### 应用顺序与正常顺序

根据 1.1.4 节中给出的求值描述，解释器首先对函数和自变量表达式求值，然后将结果函数应用于结果自变量。这不是执行评估的唯一方式。另一种评估模型不会评估参数，直到需要它们的值。取而代之的是，它将首先用实参表达式代替形参，直到获得一个只包含运算符和原始函数的表达式，然后执行求值。如果我们用这种方法，评价

```js
f(5)
```

会按照扩张的顺序进行

```js
sum_of_squares(5 + 1, 5 * 2)

square(5 + 1)     + square(5 * 2)

(5 + 1) * (5 + 1) + (5 * 2) * (5 * 2)
```

随后是削减

```js
6    *    6    +    10    *    10

    36         +         100

              136
```

这和我们之前的评估模型给出的答案是一样的，只是过程不同。特别地，这里对应于表达式的简化，`5 + 1`和`5 * 2`的评估各执行两次

```js
x * x
```

将`x`分别替换为`5 + 1`和`5 * 2`。

这种可选的“完全扩展然后缩减”评估方法被称为正常顺序评估，与解释器实际使用的“评估参数然后应用”方法形成对比，后者被称为应用顺序评估。可以看出，对于可以使用替换(包括本书前两章中的所有函数)建模并产生合法值的函数应用程序，正常顺序和应用顺序计算产生相同的值。(参考练习 1.5，了解“非法”值的实例，其中正常顺序和应用顺序评估不会给出相同的结果。)

JavaScript 使用应用顺序求值，部分原因是因为避免了对表达式的多次求值而获得了额外的效率，例如上面的`5 + 1`和`5 * 2`所示，更重要的是，因为当我们离开可以通过替换建模的函数领域时，正常顺序求值变得更加复杂。另一方面，正常秩序评估可以是一个非常有价值的工具，我们将在第三章和第四章中研究它的一些含义。 [^(13)](#c1-fn-0013)
